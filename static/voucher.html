<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beli Voucher - SELASAAT Photobooth Co.</title>
    <link rel="stylesheet" href="/static/style.css" />
    <style>
      .voucher-container {
        max-width: 600px;
        margin: 40px auto;
      }
      .package-options .card {
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.2s ease-out;
      }
      .package-options .card.selected {
        border-color: var(--teal);
        box-shadow: 0 0 0 4px var(--teal);
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        font-weight: 700;
        display: block;
        margin-bottom: 8px;
      }
      .form-group input {
        width: 100%;
        padding: 12px;
        border: var(--border-width) solid var(--black);
        font-size: 1rem;
      }
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(254, 253, 244, 0.8);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        text-align: center;
      }
      .loading-overlay p {
        font-size: 1.2rem;
      }
      .tnc-list {
        list-style-type: disc;
        padding-left: 20px;
        font-size: 0.9rem;
      }
      .tnc-list li {
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <header class="main-header">
      <div class="container logo">Beli Voucher SELASAAT</div>
    </header>

    <main>
      <div class="container voucher-container">
        <div id="form-section">
          <div class="card">
            <h2 class="section-title" style="margin-bottom: 30px">
              PILIH PAKET
            </h2>
            <div id="package-options" class="package-options"></div>
            <div class="form-group">
              <label for="email">Email Penerima Voucher</label>
              <input
                type="email"
                id="email"
                placeholder="contoh@email.com"
                required
              />
            </div>
            <button id="buy-button" class="btn" style="width: 100%">
              LANJUT KE PEMBAYARAN
            </button>
          </div>
        </div>
        <div
          id="error-message"
          class="card card--yellow"
          style="display: none; margin-top: 20px"
        ></div>
        <div class="card" style="margin-top: 30px">
          <h3 style="font-family: var(--font-heading)">Syarat & Ketentuan</h3>
          <p style="font-size: 0.9rem">
            Dengan melanjutkan pembayaran, Anda setuju dengan ketentuan berikut:
          </p>
          <ul class="tnc-list">
            <li>
              Voucher yang sudah dibeli tidak dapat diuangkan atau dikembalikan
              (non-refundable).
            </li>
            <li>
              Voucher hanya berlaku untuk satu kali pemakaian sesuai dengan
              paket yang dipilih.
            </li>
            <li>
              Masa berlaku voucher adalah 90 hari sejak tanggal pembelian.
            </li>
          </ul>
        </div>
      </div>
      <div id="loading-overlay" class="loading-overlay">
        <p>Membuka halaman pembayaran...</p>
      </div>
    </main>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const packageOptionsContainer =
          document.getElementById("package-options");
        const emailInput = document.getElementById("email");
        const buyButton = document.getElementById("buy-button");
        const loadingOverlay = document.getElementById("loading-overlay");
        const errorMessageContainer = document.getElementById("error-message");

        let selectedPackageId = null;

        try {
          const response = await fetch("/api/packages");
          const result = await response.json();
          if (result.status === "SUCCESS") {
            result.data.forEach((pkg) => {
              const card = document.createElement("div");
              card.className = "card";
              card.dataset.packageId = pkg.id;
              card.innerHTML = `<h3 style="font-family: var(--font-heading);">${
                pkg.type
              }</h3><p><strong>Rp ${new Intl.NumberFormat("id-ID").format(
                pkg.price
              )}</strong></p><p>${pkg.services}</p>`;
              card.addEventListener("click", () => {
                document
                  .querySelectorAll(".package-options .card")
                  .forEach((c) => c.classList.remove("selected"));
                card.classList.add("selected");
                selectedPackageId = pkg.id;
              });
              packageOptionsContainer.appendChild(card);
            });
          } else {
            showError("Gagal memuat paket.");
          }
        } catch (error) {
          showError("Terjadi kesalahan jaringan saat memuat paket.");
        }

        function showError(message) {
          errorMessageContainer.textContent = message;
          errorMessageContainer.style.display = "block";
        }

        buyButton.addEventListener("click", async () => {
          if (!selectedPackageId) {
            showError("Silakan pilih paket terlebih dahulu.");
            return;
          }
          if (!emailInput.value || !emailInput.validity.valid) {
            showError("Silakan masukkan alamat email yang valid.");
            return;
          }

          loadingOverlay.style.display = "flex";

          try {
            const response = await fetch("/api/vouchers/request-snap", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                package_id: selectedPackageId,
                recipient_email: emailInput.value,
              }),
            });

            const data = await response.json();

            if (response.ok && data.redirect_url) {
              window.location.href = data.redirect_url;
            } else {
              showError(data.detail || "Gagal membuat transaksi.");
              loadingOverlay.style.display = "none";
            }
          } catch (error) {
            showError("Terjadi kesalahan jaringan.");
            loadingOverlay.style.display = "none";
          }
        });
      });
    </script>
  </body>
</html>
